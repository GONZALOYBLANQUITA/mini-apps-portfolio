<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transcriptor Cl√≠nico</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#111c33;        /* deep */
      --card2:#0b1326;
      --text:#e5e7eb;        /* gray-200 */
      --muted:#94a3b8;       /* slate-400 */
      --accent:#60a5fa;      /* blue-400 */
      --ok:#34d399;          /* green-400 */
      --warn:#fbbf24;        /* amber-400 */
      --danger:#fb7185;      /* rose-400 */
      --border:rgba(148,163,184,.18);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 600px at 15% -10%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(52,211,153,.18), transparent 50%),
                  linear-gradient(180deg, #0b1022, var(--bg));
      color:var(--text);
      min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:16px 16px 10px 16px;border:1px solid var(--border);
      background:rgba(17,28,51,.65); backdrop-filter: blur(10px);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title p{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .badge{
      font-size:12px;color:#c7d2fe;border:1px solid rgba(99,102,241,.35);
      background:rgba(99,102,241,.14); padding:8px 10px;border-radius:999px; white-space:nowrap;
    }
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width: 980px){
      .grid{grid-template-columns: 1.25fr .75fr;}
    }
    .card{
      border:1px solid var(--border);
      background:rgba(17,28,51,.55);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .hd small{color:var(--muted)}
    .card .bd{padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border);
      background:rgba(148,163,184,.08);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      font-size:13px; cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(148,163,184,.14);border-color:rgba(148,163,184,.28)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background:rgba(96,165,250,.18); border-color: rgba(96,165,250,.35)}
    .btn.primary:hover{background:rgba(96,165,250,.24)}
    .btn.ok{background:rgba(52,211,153,.16); border-color: rgba(52,211,153,.32)}
    .btn.warn{background:rgba(251,191,36,.14); border-color: rgba(251,191,36,.28)}
    .btn.danger{background:rgba(251,113,133,.14); border-color: rgba(251,113,133,.28)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--border); color:var(--muted);
      background:rgba(0,0,0,.18);
    }
    textarea, input, select{
      width:100%; border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:14px;
      padding:12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:260px; resize:vertical; line-height:1.45}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    .subgrid{display:grid;gap:10px;grid-template-columns: 1fr}
    @media(min-width:560px){.subgrid{grid-template-columns:1fr 1fr}}
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height:320px; overflow:auto; padding-right:4px;
    }
    .item{
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      border-radius:14px; padding:10px;
    }
    .item .top{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .item .emo{font-weight:600;font-size:13px}
    .item .meta{color:var(--muted);font-size:12px}
    .item .note{margin-top:8px;color:#dbeafe;font-size:13px;line-height:1.35}
    .hint{color:var(--muted);font-size:12px;line-height:1.35;margin-top:10px}
    .foot{
      color:var(--muted); font-size:12px; text-align:center; padding:6px 0 2px 0;
    }
    .mono{font-family:var(--mono)}
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="title">
      <h1>Transcriptor Cl√≠nico + Registro de Emociones</h1>
      <p>
        Herramienta de apoyo para notas de sesi√≥n. La prosodia/entonaci√≥n se registra de forma cl√≠nica manual
        (marcado r√°pido durante la escucha). Sin diagn√≥stico autom√°tico.
      </p>
    </div>
    <div class="badge">Modo: Consulta ‚Ä¢ LocalStorage</div>
  </header>

  <div class="grid">

    <!-- TRANSCRIPCI√ìN -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>Transcripci√≥n</h2>
          <small id="statusTxt">Listo. Selecciona ‚ÄúIniciar‚Äù para dictado.</small>
        </div>
        <div class="row">
          <span class="pill" id="langPill">Idioma: es-ES</span>
          <span class="pill" id="recPill">Micr√≥fono: ‚Äî</span>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn primary" id="btnStart">üéôÔ∏è Iniciar</button>
          <button class="btn warn" id="btnPause" disabled>‚è∏Ô∏è Pausar</button>
          <button class="btn danger" id="btnStop" disabled>‚èπÔ∏è Detener</button>

          <button class="btn" id="btnClear">üßΩ Limpiar</button>
          <button class="btn ok" id="btnSave">üíæ Guardar</button>
          <button class="btn" id="btnLoad">‚Ü©Ô∏è Cargar</button>

          <button class="btn ok" id="btnExport">üìù Exportar a Word</button>
        </div>

        <div class="subgrid">
          <div>
            <label for="patientCode">C√≥digo / Iniciales (opcional)</label>
            <input id="patientCode" placeholder="Ej.: P-014 / Iniciales" />
          </div>
          <div>
            <label for="sessionDate">Fecha (editable)</label>
            <input id="sessionDate" />
          </div>
        </div>

        <div style="height:10px"></div>
        <label for="transcript">Texto transcrito</label>
        <textarea id="transcript" placeholder="Aqu√≠ aparecer√° la transcripci√≥n..."></textarea>

        <div class="hint">
          Tip: si quieres separar al terapeuta del paciente, puedes escribir marcadores manuales tipo:
          <span class="mono">[T]:</span> y <span class="mono">[P]:</span>
        </div>
      </div>
    </section>

    <!-- EMOCIONES (PROSODIA/ENTONACI√ìN) -->
    <aside class="card">
      <div class="hd">
        <div>
          <h2>Emociones observadas (prosodia / entonaci√≥n)</h2>
          <small>Marcado cl√≠nico r√°pido con timestamp</small>
        </div>
        <div class="row">
          <button class="btn" id="btnAddQuick">‚ûï Registrar</button>
          <button class="btn danger" id="btnClearEmo">üóëÔ∏è Vaciar</button>
        </div>
      </div>
      <div class="bd">
        <div class="subgrid">
          <div>
            <label for="emoType">Emoci√≥n principal</label>
            <select id="emoType">
              <option>Ansiedad</option>
              <option>Tristeza</option>
              <option>Ira</option>
              <option>Frustraci√≥n</option>
              <option>Miedo</option>
              <option>Culpa</option>
              <option>Verg√ºenza</option>
              <option>Desesperanza</option>
              <option>Alivio</option>
              <option>Alegr√≠a</option>
              <option>Calma</option>
              <option>Ambivalencia</option>
              <option>Desregulaci√≥n</option>
              <option>Otra</option>
            </select>
          </div>
          <div>
            <label for="emoInt">Intensidad (0‚Äì10)</label>
            <input id="emoInt" type="number" min="0" max="10" value="6" />
          </div>
        </div>

        <div style="height:10px"></div>
        <label for="emoNote">Nota breve (qu√© te lo hizo inferir)</label>
        <input id="emoNote" placeholder="Ej.: Voz quebrada, pausas largas, aumento de volumen..." />

        <div style="height:10px"></div>
        <div class="row">
          <button class="btn primary" id="btnAdd">‚úÖ A√±adir a lista</button>
          <span class="pill" id="emoCount">0 registros</span>
        </div>

        <div style="height:12px"></div>
        <div class="list" id="emoList"></div>

        <div class="hint">
          Nota: el navegador no ofrece prosodia ‚Äúreal‚Äù de forma est√°ndar. Este m√≥dulo est√° pensado para
          que t√∫ registres tu **observaci√≥n cl√≠nica** (entonaci√≥n, ritmo, silencios, intensidad), con rapidez
          y orden.
        </div>
      </div>
    </aside>

  </div>

  <div class="foot">Todas las mini aplicaciones fueron desarrolladas por Lic. Gonzalo Buend√≠a ‚Äì Psic√≥logo, y Blanquita ‚Äì Co terapeuta.</div>
</div>

<script>
(() => {
  // --- Fecha por defecto ---
  const pad = n => String(n).padStart(2,"0");
  const now = new Date();
  const localISO = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  const sessionDate = document.getElementById("sessionDate");
  sessionDate.value = localISO;

  // --- Elementos ---
  const statusTxt = document.getElementById("statusTxt");
  const recPill = document.getElementById("recPill");
  const transcript = document.getElementById("transcript");
  const patientCode = document.getElementById("patientCode");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const btnStop  = document.getElementById("btnStop");
  const btnClear = document.getElementById("btnClear");
  const btnSave  = document.getElementById("btnSave");
  const btnLoad  = document.getElementById("btnLoad");
  const btnExport= document.getElementById("btnExport");

  const emoType = document.getElementById("emoType");
  const emoInt  = document.getElementById("emoInt");
  const emoNote = document.getElementById("emoNote");
  const btnAdd  = document.getElementById("btnAdd");
  const btnAddQuick = document.getElementById("btnAddQuick");
  const btnClearEmo = document.getElementById("btnClearEmo");
  const emoList = document.getElementById("emoList");
  const emoCount= document.getElementById("emoCount");

  // --- Estado ---
  let recognition = null;
  let isListening = false;
  let isPaused = false;
  let finalText = "";
  let emotions = [];

  // --- SpeechRecognition (Web Speech API) ---
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  function setUIState(listening){
    btnStart.disabled = listening;
    btnPause.disabled = !listening;
    btnStop.disabled  = !listening;
    recPill.textContent = listening ? "Micr√≥fono: ON" : "Micr√≥fono: OFF";
  }

  function initRecognition(){
    if(!SpeechRecognition){
      statusTxt.textContent = "Este navegador no soporta dictado (SpeechRecognition). Usa Chrome/Edge en desktop o Android.";
      btnStart.disabled = true;
      recPill.textContent = "Micr√≥fono: No compatible";
      return null;
    }

    const r = new SpeechRecognition();
    r.lang = "es-ES";
    r.continuous = true;
    r.interimResults = true;

    r.onstart = () => {
      isListening = true; isPaused = false;
      statusTxt.textContent = "Escuchando‚Ä¶";
      setUIState(true);
    };

    r.onend = () => {
      isListening = false; isPaused = false;
      statusTxt.textContent = "Detenido.";
      setUIState(false);
      // Al detenerse (a veces por silencio), no borramos nada.
    };

    r.onerror = (e) => {
      statusTxt.textContent = "Error de micr√≥fono/dictado: " + (e.error || "desconocido");
      setUIState(false);
    };

    r.onresult = (event) => {
      let interim = "";
      for (let i = event.resultIndex; i < event.results.length; i++){
        const res = event.results[i];
        const txt = res[0]?.transcript || "";
        if(res.isFinal){
          finalText += (finalText && !finalText.endsWith("\n") ? " " : "") + txt.trim();
        } else {
          interim += txt;
        }
      }
      transcript.value = finalText + (interim ? "\n\n[... " + interim.trim() + " ...]" : "");
      // Guardado suave
      softPersist();
    };

    return r;
  }

  recognition = initRecognition();
  setUIState(false);

  // --- Persistencia ---
  const KEY = "transcriptor_clinico_v1";
  function softPersist(){
    const payload = {
      patientCode: patientCode.value.trim(),
      sessionDate: sessionDate.value,
      finalText,
      emotions
    };
    localStorage.setItem(KEY, JSON.stringify(payload));
  }

  function loadPersist(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return false;
    try{
      const data = JSON.parse(raw);
      patientCode.value = data.patientCode || "";
      sessionDate.value = data.sessionDate || localISO;
      finalText = data.finalText || "";
      emotions = Array.isArray(data.emotions) ? data.emotions : [];
      transcript.value = finalText;
      renderEmotions();
      return true;
    }catch{
      return false;
    }
  }

  // --- Emociones ---
  function ts(){
    const d = new Date();
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function addEmotion(entry){
    emotions.unshift(entry);
    renderEmotions();
    softPersist();
  }

  function renderEmotions(){
    emoList.innerHTML = "";
    emoCount.textContent = `${emotions.length} registros`;
    emotions.forEach((e, idx) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div class="emo">${escapeHtml(e.type)} <span class="pill" style="margin-left:8px">Intensidad: ${escapeHtml(String(e.intensity))}/10</span></div>
          <div class="meta">${escapeHtml(e.time)}${e.marker ? " ‚Ä¢ " + escapeHtml(e.marker) : ""}</div>
        </div>
        ${e.note ? `<div class="note">${escapeHtml(e.note)}</div>` : ""}
        <div class="row" style="margin-top:10px">
          <button class="btn danger" data-del="${idx}">Eliminar</button>
        </div>
      `;
      emoList.appendChild(div);
    });

    emoList.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        emotions.splice(i, 1);
        renderEmotions();
        softPersist();
      });
    });
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[s]));
  }

  // --- Export a Word (HTML -> .doc) ---
  function exportToWord(){
    const code = patientCode.value.trim() || "‚Äî";
    const date = sessionDate.value || localISO;
    const transcriptText = (finalText || transcript.value || "").replace(/\n/g, "<br/>");

    const emotionsHtml = emotions.length ? emotions.map(e => `
      <tr>
        <td style="padding:8px;border:1px solid #ddd">${escapeHtml(e.time)}</td>
        <td style="padding:8px;border:1px solid #ddd"><b>${escapeHtml(e.type)}</b> (Int. ${escapeHtml(String(e.intensity))}/10)</td>
        <td style="padding:8px;border:1px solid #ddd">${escapeHtml(e.note || "")}</td>
      </tr>
    `).join("") : `
      <tr><td colspan="3" style="padding:10px;border:1px solid #ddd;color:#555">Sin registros de emociones observadas.</td></tr>
    `;

    const html = `
    <!doctype html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Registro de Sesi√≥n</title>
    </head>
    <body style="font-family:Calibri, Arial, sans-serif; font-size:11pt; color:#111;">
      <h2 style="margin:0 0 8px 0;">Registro de Sesi√≥n (Transcripci√≥n + Emociones observadas)</h2>
      <p style="margin:0 0 14px 0;">
        <b>C√≥digo/Iniciales:</b> ${escapeHtml(code)}<br/>
        <b>Fecha:</b> ${escapeHtml(date)}
      </p>

      <h3 style="margin:10px 0 6px 0;">1) Transcripci√≥n</h3>
      <div style="border:1px solid #ddd; padding:10px; border-radius:6px; line-height:1.4;">
        ${transcriptText || "<i>(vac√≠o)</i>"}
      </div>

      <h3 style="margin:14px 0 6px 0;">2) Emociones observadas (prosodia / entonaci√≥n)</h3>
      <p style="margin:0 0 8px 0; color:#444;">
        Registro cl√≠nico manual basado en entonaci√≥n, ritmo, pausas, intensidad y coherencia afectiva.
      </p>
      <table style="border-collapse:collapse; width:100%; font-size:10.5pt;">
        <thead>
          <tr>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;background:#f3f4f6;">Hora</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;background:#f3f4f6;">Emoci√≥n</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;background:#f3f4f6;">Nota cl√≠nica</th>
          </tr>
        </thead>
        <tbody>
          ${emotionsHtml}
        </tbody>
      </table>

      <p style="margin-top:14px;color:#666;font-size:10pt;">
        Generado por herramienta de apoyo cl√≠nico. No constituye diagn√≥stico autom√°tico.
      </p>

      <p style="margin-top:18px;color:#666;font-size:10pt;">
        Todas las mini aplicaciones fueron desarrolladas por Lic. Gonzalo Buend√≠a ‚Äì Psic√≥logo, y Blanquita ‚Äì Co terapeuta.
      </p>
    </body>
    </html>`;

    const blob = new Blob([html], { type: "application/msword" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;

    const safeName = `Sesion_${(code !== "‚Äî" ? code : "Paciente")}_${date}`.replace(/[^\w\-]+/g, "_");
    a.download = `${safeName}.doc`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // --- Eventos ---
  btnStart.addEventListener("click", async () => {
    if(!recognition) return;
    try{
      // Pedimos permiso de micr√≥fono (mejora UX en algunos navegadores)
      await navigator.mediaDevices.getUserMedia({ audio: true });
      recPill.textContent = "Micr√≥fono: OK";
    }catch{
      statusTxt.textContent = "No se concedi√≥ permiso de micr√≥fono.";
      return;
    }
    // Limpia el texto interino si hab√≠a
    transcript.value = finalText || "";
    recognition.start();
  });

  btnPause.addEventListener("click", () => {
    if(!recognition) return;
    if(!isListening) return;
    // No hay "pause" real en SpeechRecognition; hacemos stop y marcamos pausa
    isPaused = true;
    statusTxt.textContent = "Pausado.";
    recognition.stop();
  });

  btnStop.addEventListener("click", () => {
    if(!recognition) return;
    statusTxt.textContent = "Deteniendo‚Ä¶";
    recognition.stop();
    softPersist();
  });

  btnClear.addEventListener("click", () => {
    finalText = "";
    transcript.value = "";
    softPersist();
  });

  btnSave.addEventListener("click", () => {
    finalText = (transcript.value || "").replace(/\n\n\[\.{3}.*?\.\.\.\]\s*$/s, "").trim();
    transcript.value = finalText;
    softPersist();
    statusTxt.textContent = "Guardado localmente.";
  });

  btnLoad.addEventListener("click", () => {
    const ok = loadPersist();
    statusTxt.textContent = ok ? "Cargado desde guardado local." : "No hay guardado previo.";
  });

  btnExport.addEventListener("click", () => {
    // Asegura que finalText tenga la √∫ltima versi√≥n limpia
    finalText = (transcript.value || "").replace(/\n\n\[\.{3}.*?\.\.\.\]\s*$/s, "").trim();
    exportToWord();
  });

  btnAdd.addEventListener("click", () => {
    const type = emoType.value;
    const intensity = Math.max(0, Math.min(10, Number(emoInt.value || 0)));
    const note = (emoNote.value || "").trim();
    addEmotion({ time: ts(), type, intensity, note, marker: isListening ? "durante dictado" : "" });
    emoNote.value = "";
  });

  btnAddQuick.addEventListener("click", () => {
    // Registro r√°pido con campos actuales
    const type = emoType.value;
    const intensity = Math.max(0, Math.min(10, Number(emoInt.value || 0)));
    addEmotion({ time: ts(), type, intensity, note: "", marker: isListening ? "durante dictado" : "" });
  });

  btnClearEmo.addEventListener("click", () => {
    emotions = [];
    renderEmotions();
    softPersist();
  });

  // Carga inicial si existe
  loadPersist();

})();
</script>
</body>
</html>
